<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>TilePad â€” Simple</title>
  <style>
    :root{ --bg:#0b0f14; --card:#0f172a; --text:#e5ecf3; --muted:#98a2b3; --acc:#7c3aed; --good:#22c55e; --danger:#ef4444; --tb:72px; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow:hidden}
    .app{min-height:100vh;display:flex;flex-direction:column;overflow:hidden}

    /* Viewer fills all available space */
    .viewer{position:relative;flex:1;display:flex;align-items:center;justify-content:center;padding:8px 8px calc(var(--tb) + 8px);background:linear-gradient(180deg,#0f172a,#0b0f14)}
    .frame{position:relative;display:flex;align-items:center;justify-content:center;width:min(calc(100vw - 24px), 820px);height:calc(100vh - var(--tb) - 24px - env(safe-area-inset-bottom));min-height:320px;background:radial-gradient(800px 240px at 50% -120px, rgba(124,58,237,.12), transparent),var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.35);overflow:hidden}
    canvas{display:block;max-width:100%;max-height:100%;width:auto;height:auto;background:repeating-conic-gradient(from 45deg, rgba(255,255,255,.04) 0 10deg, transparent 10deg 20deg) center/40px 40px;border-radius:8px}

    /* Bottom toolbar: exactly 4 equal buttons, responsive */
    .toolbar{position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(10,14,22,.75);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);padding:8px max(8px, env(safe-area-inset-left)) max(8px, calc(env(safe-area-inset-bottom) + 8px)) max(8px, env(safe-area-inset-right));}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;max-width:900px;margin:0 auto}
    .btn{appearance:none;border:none;border-radius:14px;padding:clamp(10px,2.5vh,14px);font-weight:700;color:var(--text);background:linear-gradient(180deg,#1a2435,#141c2b);border:1px solid rgba(255,255,255,.08);box-shadow:0 6px 18px rgba(0,0,0,.25);transition:transform .06s ease, box-shadow .2s ease;touch-action:manipulation;font-size:clamp(14px,2.6vw,16px)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(124,58,237,.45);}
    .btn.good{border-color:rgba(34,197,94,.45);}
    .btn[disabled]{opacity:.55;filter:saturate(.6);pointer-events:none}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(64px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 14px;font-size:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s ease;max-width:90%;text-align:center}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">
  <main class="viewer" role="main" aria-label="Image viewer">
    <div id="frame" class="frame" aria-label="Image window">
      <canvas id="canvas" aria-label="Image canvas"></canvas>
    </div>
    <input id="file" type="file" accept="image/*,.heic,.heif,.avif" class="sr-only" hidden />
  </main>

  <nav class="toolbar" aria-label="Controls">
    <div class="grid">
      <button id="btnUpload" class="btn primary" title="Upload image">Upload</button>
      <button id="btnEncode" class="btn" title="Encode (shuffle)">Encode</button>
      <button id="btnDecode" class="btn" title="Decode (unshuffle)">Decode</button>
      <button id="btnShare"  class="btn good" title="Share">Share</button>
    </div>
  </nav>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  'use strict';
  // ---- Parameters (robust defaults) ----
  const TILE = 32;          // tile size (px)
  const LONG_EDGE = 1280;   // normalize long edge for cross-device consistency
  const SEED = 0x41C0FFEE;  // deterministic plan

  // PRNG
  function* prng(seed){ let x=seed>>>0; while(true){ x^=x<<13; x>>>=0; x^=x>>>17; x>>>=0; x^=x<<5; x>>>=0; yield x>>>0; } }
  function makePlan(cols, rows){
    const n = cols*rows, order = Array.from({length:n},(_,i)=>i); const p = prng(SEED ^ cols ^ (rows<<16));
    for (let i=n-1;i>0;i--){ const r=p.next().value % (i+1); [order[i],order[r]]=[order[r],order[i]]; }
    const rot = new Uint8Array(n); for (let i=0;i<n;i++) rot[i]=(p.next().value)&3; return {order,rot};
  }

  // DOM
  const $ = s=>document.querySelector(s);
  const canvas = $('#canvas'); const ctx = canvas.getContext('2d', { willReadFrequently:true });
  const work = document.createElement('canvas'); const wctx = work.getContext('2d', { willReadFrequently:true });
  const input = $('#file');
  const btnUpload=$('#btnUpload'), btnEncode=$('#btnEncode'), btnDecode=$('#btnDecode'), btnShare=$('#btnShare');
  const toastEl = $('#toast');
  const toolbar = document.querySelector('.toolbar');
  const frame = document.querySelector('#frame');

  // State
  let hasImage=false, encoded=false; let naturalW=0,naturalH=0; let cols=0,rows=0; let plan=null;

  // UI helpers
  function showToast(t){ toastEl.textContent=t; toastEl.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toastEl.classList.remove('show'),1700); }
  function updateButtons(){ btnEncode.disabled=!hasImage; btnDecode.disabled=!hasImage; btnShare.disabled=!hasImage; }
  function fitToCanvas(w,h){
    const parent = frame || canvas.parentElement;
    const styles = getComputedStyle(parent);
    const padTop = parseFloat(styles.paddingTop)||0;
    const padBottom = parseFloat(styles.paddingBottom)||0;
    const padLeft = parseFloat(styles.paddingLeft)||0;
    const padRight = parseFloat(styles.paddingRight)||0;
    const availW = Math.max(1, parent.clientWidth - padLeft - padRight);
    const availH = Math.max(1, parent.clientHeight - padTop - padBottom);
    const s = Math.min(availW / w, availH / h);
    const tw = Math.max(1, Math.round(w * s));
    const th = Math.max(1, Math.round(h * s));
    canvas.width = tw; canvas.height = th;
  }
  function redraw(){ if(!hasImage) return; fitToCanvas(naturalW,naturalH); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(work,0,0,canvas.width,canvas.height); }

  // Robust loaders
  async function loadBitmapFromFile(file){
    const type=(file.type||'').toLowerCase(); const name=(file.name||'').toLowerCase(); const isHeicLike=/heic|heif/.test(name)||/image\/(heic|heif)/.test(type);
    if(!isHeicLike && 'createImageBitmap' in window){ try{ return await createImageBitmap(file); }catch(e){ console.warn('createImageBitmap failed; fallback', e); } }
    return await new Promise((resolve, reject)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{ URL.revokeObjectURL(url); resolve(img); }; img.onerror=()=>{ URL.revokeObjectURL(url); reject(new Error('decode-failed')); }; try{ img.decoding='async'; }catch{} img.src=url; });
  }

  function normalizeIntoWork(bmp){
    let w=bmp.width||bmp.naturalWidth, h=bmp.height||bmp.naturalHeight;
    const scale=Math.min(1, LONG_EDGE/Math.max(w,h)); const w1=Math.max(TILE, Math.round(w*scale)); const h1=Math.max(TILE, Math.round(h*scale));
    const tmp=document.createElement('canvas'); tmp.width=w1; tmp.height=h1; tmp.getContext('2d').drawImage(bmp,0,0,w1,h1);
    const wT = Math.max(TILE, Math.floor(w1/TILE)*TILE); const hT = Math.max(TILE, Math.floor(h1/TILE)*TILE);
    const sx=Math.floor((w1-wT)/2), sy=Math.floor((h1-hT)/2);
    work.width=wT; work.height=hT; wctx.clearRect(0,0,wT,hT); wctx.drawImage(tmp, sx,sy,wT,hT, 0,0,wT,hT);
    naturalW=wT; naturalH=hT; cols=Math.floor(wT/TILE); rows=Math.floor(hT/TILE);
  }

  async function drawBitmap(bmp){ normalizeIntoWork(bmp); hasImage=true; encoded=false; plan=null; redraw(); updateButtons(); }

  // Encode/Decode
  function encodeTiles(){ if(!hasImage||encoded) return; const src=document.createElement('canvas'); src.width=naturalW; src.height=naturalH; src.getContext('2d').drawImage(work,0,0); const out=document.createElement('canvas'); out.width=naturalW; out.height=naturalH; const ox=out.getContext('2d'); plan=makePlan(cols,rows); const n=cols*rows,s=TILE; for(let i=0;i<n;i++){ const srcIdx=i, dstIdx=plan.order[i], r=plan.rot[i]; const sx=(srcIdx%cols)*s, sy=Math.floor(srcIdx/cols)*s; const dx=(dstIdx%cols)*s, dy=Math.floor(dstIdx/cols)*s; ox.save(); ox.translate(dx+s/2, dy+s/2); ox.rotate((r%4)*Math.PI/2); ox.drawImage(src, sx,sy,s,s, -s/2,-s/2,s,s); ox.restore(); } wctx.clearRect(0,0,naturalW,naturalH); wctx.drawImage(out,0,0); encoded=true; redraw(); }
  function decodeTiles(){ if(!hasImage||!encoded){ /* allow trying decode anyway with same plan */ } if(!plan) plan=makePlan(cols,rows); const src=document.createElement('canvas'); src.width=naturalW; src.height=naturalH; src.getContext('2d').drawImage(work,0,0); const out=document.createElement('canvas'); out.width=naturalW; out.height=naturalH; const ox=out.getContext('2d'); const n=cols*rows,s=TILE; for(let i=0;i<n;i++){ const srcIdx=plan.order[i], dstIdx=i, r=(4-(plan.rot[i]%4))%4; const sx=(srcIdx%cols)*s, sy=Math.floor(srcIdx/cols)*s; const dx=(dstIdx%cols)*s, dy=Math.floor(dstIdx/cols)*s; ox.save(); ox.translate(dx+s/2, dy+s/2); ox.rotate(r*Math.PI/2); ox.drawImage(src, sx,sy,s,s, -s/2,-s/2,s,s); ox.restore(); } wctx.clearRect(0,0,naturalW,naturalH); wctx.drawImage(out,0,0); encoded=false; redraw(); }

  // Share (normal JPEG for WhatsApp)
  function shareNow(){ if(!hasImage) return showToast('Nothing to share'); try{ work.toBlob(async blob=>{ if(!blob){ showToast('Export failed'); return; } const file=new File([blob], encoded?'tile-encoded.jpg':'tile.jpg',{type:'image/jpeg'}); try{ if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file], title:'TilePad'}); } else { const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),800); showToast('Downloaded'); } }catch(e){ console.error(e); showToast('Share failed'); } }, 'image/jpeg', 0.92); }catch(e){ console.error(e); showToast('Export error'); } }

  // Handlers
  btnUpload.addEventListener('click', ()=> input.click());
  input.addEventListener('change', async e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; try{ const bmp=await loadBitmapFromFile(f); await drawBitmap(bmp); }catch(err){ console.error(err); showToast('Could not open image'); } finally { updateButtons(); }});
  btnEncode.addEventListener('click', ()=>{ if(!hasImage) return; try{ encodeTiles(); }catch(e){ console.error(e); showToast('Encode failed'); } });
  btnDecode.addEventListener('click', ()=>{ if(!hasImage) return; try{ decodeTiles(); }catch(e){ console.error(e); showToast('Decode failed'); } });
  btnShare .addEventListener('click', shareNow);

  // Resize
  // Resize & safe-area aware toolbar height
  window.addEventListener('resize', ()=>{ redraw(); }, {passive:true});
  const ro = new ResizeObserver(()=>{
    if(!toolbar) return;
    const tb = toolbar.getBoundingClientRect().height;
    document.documentElement.style.setProperty('--tb', Math.ceil(tb) + 'px');
    redraw();
  });
  if (toolbar) ro.observe(toolbar);
  const ro2 = new ResizeObserver(()=>{ redraw(); });
  if (frame) ro2.observe(frame);
})();
</script>
</body>
</html>
