<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>StegoPad — Encode/Decode Image</title>
  <style>
    body {margin:0; font-family: system-ui, sans-serif; background:#0b0f14; color:#e5ecf3;}
    header {padding:1rem; text-align:center; background:#111827; font-weight:bold;}
    main {padding:1rem;}
    .viewer {display:flex; justify-content:center; align-items:center; background:#1e293b; border-radius:12px; padding:1rem; margin-bottom:1rem; min-height:200px;}
    canvas {max-width:100%; border-radius:8px; background:#0f172a;}
    .toolbar {display:grid; grid-template-columns:repeat(5,1fr); gap:0.5rem;}
    button {padding:0.6rem; border:none; border-radius:8px; background:#334155; color:#e5ecf3; font-weight:bold;}
    button:disabled {opacity:0.5;}
    .danger {background:#7f1d1d;}
  </style>
</head>
<body>
  <header>StegoPad — Encode / Decode</header>
  <main>
    <div class="viewer">
      <canvas id="canvas" width="0" height="0"></canvas>
    </div>
    <div class="toolbar">
      <button id="btnUpload">Upload</button>
      <button id="btnEncode">Encode</button>
      <button id="btnDecode">Decode</button>
      <button id="btnShare">Share</button>
      <button id="btnReset" class="danger">Reset</button>
    </div>
    <input id="file" type="file" accept=".stego,image/*" style="display:none" />
  </main>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('file');
    const btnUpload = document.getElementById('btnUpload');
    const btnEncode = document.getElementById('btnEncode');
    const btnDecode = document.getElementById('btnDecode');
    const btnShare = document.getElementById('btnShare');
    const btnReset = document.getElementById('btnReset');

    let hasImage = false;
    let encoded = false;
    let originalImage = null;

    const SEED = 0xC0FFEE ^ 0x5EEDBEEF;
    const KEY = 0xA1B2C3D4;
    function* prng(seed){let x=seed>>>0;while(true){x^=x<<13;x>>>=0;x^=x>>>17;x>>>=0;x^=x<<5;x>>>=0;yield x>>>0;}}
    function scramble(img){
      const p=prng(SEED^img.width^(img.height<<16)^KEY);
      const d=img.data;
      for(let i=0;i<d.length;i+=4){
        const r=p.next().value;
        d[i]^=(r)&0xFF;d[i+1]^=(r>>>8)&0xFF;d[i+2]^=(r>>>16)&0xFF;
      }
      return img;
    }

    async function loadFile(file){
      if(!file) return;
      // If a .stego file was chosen, treat its bytes as a PNG to avoid gallery compression issues
      const isStego = file.name.toLowerCase().endsWith('.stego');
      let url;
      if(isStego){
        const buf = await file.arrayBuffer();
        const blob = new Blob([buf], {type:'image/png'}); // original PNG bytes preserved
        url = URL.createObjectURL(blob);
      } else {
        url = URL.createObjectURL(file);
      }
      const img = new Image();
      img.onload = ()=>{
        canvas.width=img.width; canvas.height=img.height;
        ctx.drawImage(img,0,0);
        hasImage=true; encoded=false; originalImage=img;
        URL.revokeObjectURL(url);
      };
      img.onerror = ()=>{
        URL.revokeObjectURL(url);
        alert('Could not load file. If you received it via WhatsApp as an image, it was likely compressed. Ask the sender to share the .stego document instead.');
      };
      img.src=url;
    };
      img.src=url;
    }

    function applyScramble(){
      const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
      scramble(imgData);
      ctx.putImageData(imgData,0,0);
    }

    btnUpload.onclick=()=>fileInput.click();
    fileInput.onchange=(e)=>loadFile(e.target.files[0]);
    btnEncode.onclick=()=>{if(hasImage&&!encoded){applyScramble();encoded=true;}};
    btnDecode.onclick=()=>{if(hasImage&&encoded){applyScramble();encoded=false;}};
    btnShare.onclick=async()=>{
      if(!hasImage)return;
      canvas.toBlob(async blob=>{
        const pngFile=new File([blob], encoded?"image-encoded.png":"image.png",{type:'image/png'});
        const stegoFile=new File([blob], encoded?"image-encoded.stego":"image.stego",{type:'application/octet-stream'});
        try{
          if(navigator.share && navigator.canShare && navigator.canShare({files:[pngFile,stegoFile]})){
            await navigator.share({files:[pngFile,stegoFile],title:'StegoPad',text:'Send the .stego as a Document to preserve exact pixels (e.g., in WhatsApp).'});
          }else if(navigator.share && navigator.canShare && navigator.canShare({files:[pngFile]})){
            await navigator.share({files:[pngFile],title:'StegoPad'});
            alert('Tip: For WhatsApp, sending as an IMAGE will be compressed and decoding will fail. Instead, share the .stego file as a Document. If not offered here, use the download links and attach in WhatsApp as Document.');
          }else{
            const url1=URL.createObjectURL(blob);
            const a1=document.createElement('a'); a1.href=url1; a1.download=pngFile.name; a1.click();
            const url2=URL.createObjectURL(new Blob([blob],{type:'application/octet-stream'}));
            const a2=document.createElement('a'); a2.href=url2; a2.download=stegoFile.name; a2.click();
            setTimeout(()=>{URL.revokeObjectURL(url1);URL.revokeObjectURL(url2);},1000);
            alert('Downloaded PNG and .stego. For WhatsApp, attach the .stego as a Document to avoid compression.');
          }
        }catch(e){ console.error(e); alert('Share failed. You can still use the download fallback.'); }
      },'image/png',1);
    };
    btnReset.onclick=()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      canvas.width=0;canvas.height=0;hasImage=false;encoded=false;originalImage=null;
    };
  </script>
</body>
</html>
