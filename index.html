<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>Image Encoder</title>
<style>
  :root{ --bg:#0f1115; --grad1:#0b0d12; --grad2:#121520; --bar:#10131b; --bar-brd:#1f2432; --txt:#e8ecf3; --muted:#a7b0c0; --pad:12px; --btn-radius:12px; }
  *{ box-sizing:border-box; }
  html, body { height: 100svh; margin: 0; overflow: hidden; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--txt);
    background: radial-gradient(1200px 800px at 20% -10%, var(--grad1), transparent),
                radial-gradient(1000px 900px at 120% 10%, var(--grad2), transparent),
                var(--bg);
  }
  .app{ height:100%; display:flex; flex-direction:column; overflow:hidden; }
  #stage{ flex:1; display:flex; align-items:center; justify-content:center; padding: var(--pad); overflow:hidden; }
  .stage-card{ display:flex; flex-direction:column; align-items:center; max-width:100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
    border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px);
  }
  canvas{ display:block; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background:#0b0e15; margin:0; max-width:100%; max-height:100%; }
  #hint{ margin-top:10px; color:var(--muted); font-size:12.5px; text-align:center; }
  #bar{ position: fixed; left:0; right:0; bottom:0; display:flex; gap:8px; flex-wrap:nowrap; justify-content:space-between; align-items:center;
    padding: clamp(6px, 1.2vh, 10px) clamp(var(--pad), 3vw, 20px) calc(clamp(6px,1.2vh,10px) + env(safe-area-inset-bottom));
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), var(--bar);
    border-top: 1px solid var(--bar-brd); box-shadow: 0 -8px 24px rgba(0,0,0,.35); backdrop-filter: blur(8px); z-index:10;
  }
  .action{ appearance:none; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    color:var(--txt); padding: clamp(6px, 1.4vh, 10px) clamp(8px, 2.3vw, 12px); border-radius: var(--btn-radius); font-size: clamp(12px, 2.6vw, 14px);
    line-height:1; text-align:center; flex: 1 1 0; min-width:0; white-space:nowrap; cursor:pointer;
    transition: transform .05s ease, box-shadow .15s ease, border-color .2s ease; box-shadow: 0 2px 10px rgba(0,0,0,.25);
  }
  .action:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
  .action:active{ transform: translateY(1px) scale(.99); }
  .encode{ border-color: rgba(110,168,254,.35); box-shadow: 0 2px 12px rgba(110,168,254,.18); }
  .decode{ border-color: rgba(167,139,250,.35); box-shadow: 0 2px 12px rgba(167,139,250,.18); }
  .share { border-color: rgba(86,211,100,.35); box-shadow: 0 2px 12px rgba(86,211,100,.18); }
  .reset { border-color: rgba(255,107,107,.35); box-shadow: 0 2px 12px rgba(255,107,107,.18); }
  label.upload{ display:inline-flex; align-items:center; justify-content:center; gap:8px; }
  input[type="file"]{ display:none; }
</style>
</head>
<body>
  <div class="app">
    <div id="stage">
      <div class="stage-card" id="card">
        <canvas id="canvas"></canvas>
        <div id="hint">Upload an image to begin. If you upload a scrambled image, tap Decode.</div>
      </div>
    </div>

    <div id="bar">
      <label class="upload action" title="Upload"><input id="file" type="file" accept="image/*" />Upload</label>
      <button id="encode" class="action encode" disabled>Encode</button>
      <button id="decode" class="action decode" disabled>Decode</button>
      <button id="share"  class="action share"  disabled>Share</button>
      <button id="reset"  class="action reset"  disabled>Reset</button>
    </div>
  </div>

<script>
// ===== Fixed key (use the same value on all devices) =====
const SEED_8_DIGITS = 12345678;

// ===== Safety caps for very large photos (prevents blank canvas) =====
const MAX_BACKING_PIXELS = 25_000_000;  // ~25 MP
const MAX_BACKING_SIDE   = 8192;        // per-side safety cap (WebKit/iOS friendly)

// ===== DOM =====
const fileInput = document.getElementById('file');
const canvas    = document.getElementById('canvas');
const ctx       = canvas.getContext('2d', { willReadFrequently: true });
const encodeBtn = document.getElementById('encode');
const decodeBtn = document.getElementById('decode');
const shareBtn  = document.getElementById('share');
const resetBtn  = document.getElementById('reset');
const hint      = document.getElementById('hint');
const stage     = document.getElementById('stage');
const bar       = document.getElementById('bar');
const card      = document.getElementById('card');

// ===== State =====
let hasImage = false, isScrambled = null, imgW = 0, imgH = 0;
let dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

// ===== Endianness masks =====
const LITTLE   = new Uint8Array(new Uint32Array([0x01020304]).buffer)[0] === 0x04;
const RGB_MASK = LITTLE ? 0x00FFFFFF : 0xFFFFFF00;
const A_MASK   = LITTLE ? 0xFF000000 : 0x000000FF;

// ===== Fast PRNG (xorshift32) =====
function makeXorShift32(seed) { let x=(seed>>>0)||0x6D2B79F5; return () => { x^=(x<<13); x^=(x>>>17); x^=(x<<5); return x>>>0; }; }

// ===== Scramble/descramble (v2, XOR RGB, preserve alpha) =====
function applyScramble(seed) {
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const u32 = new Uint32Array(img.data.buffer, 0, img.data.length >>> 2);
  const next32 = makeXorShift32(seed);
  for (let i = 0; i < u32.length; i++) {
    const r = next32();
    u32[i] = (u32[i] & A_MASK) | ((u32[i] ^ r) & RGB_MASK);
  }
  ctx.putImageData(img, 0, 0);
}

// ===== Buttons =====
function setButtons(){
  if(!hasImage){ encodeBtn.disabled=decodeBtn.disabled=shareBtn.disabled=resetBtn.disabled=true; return; }
  if(isScrambled===null){ encodeBtn.disabled=false; decodeBtn.disabled=false; }
  else { encodeBtn.disabled=isScrambled; decodeBtn.disabled=!isScrambled; }
  shareBtn.disabled=false; resetBtn.disabled=false;
}

// ===== Layout helpers =====
function px(n){ return isNaN(n)?0:n; }
function getBoxSpacing(el){ const s=getComputedStyle(el); return {
  pl:px(parseFloat(s.paddingLeft)), pr:px(parseFloat(s.paddingRight)),
  pt:px(parseFloat(s.paddingTop)),  pb:px(parseFloat(s.paddingBottom)),
  bl:px(parseFloat(s.borderLeftWidth)), br:px(parseFloat(s.borderRightWidth)),
  bt:px(parseFloat(s.borderTopWidth)), bb:px(parseFloat(s.borderBottomWidth)),
};}
function sizeViewerToImage(){
  const vw=document.documentElement.clientWidth, vh=document.documentElement.clientHeight;
  const barH=bar.getBoundingClientRect().height, sb=getBoxSpacing(stage), cb=getBoxSpacing(card), hintH=hint.getBoundingClientRect().height||0;
  const availW=Math.max(1, vw - (sb.pl+sb.pr) - (cb.pl+cb.pr) - (cb.bl+cb.br) - 2);
  const availH=Math.max(1, vh - barH - (sb.pt+sb.pb) - (cb.pt+cb.pb) - (cb.bt+cb.bb) - hintH - 8);
  if(!imgW||!imgH){ canvas.style.width=Math.max(120,Math.floor(Math.min(availW,520)))+'px'; canvas.style.height=Math.max(90,Math.floor(Math.min(availH,320)))+'px'; return; }
  const scale = Math.min(availW/imgW, availH/imgH, 1);
  canvas.style.width  = Math.floor(imgW*scale)+'px';
  canvas.style.height = Math.floor(imgH*scale)+'px';
}
function adjustStagePadding(){ stage.style.paddingBottom=(bar.getBoundingClientRect().height+6)+'px'; sizeViewerToImage(); }
window.addEventListener('resize', ()=>{ dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1)); adjustStagePadding(); });
window.addEventListener('orientationchange', ()=>setTimeout(()=>{ dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1)); adjustStagePadding(); },60));

// ===== Hi-DPI draw with safety caps (handles huge gallery photos) =====
function drawImageHiDPI(img) {
  imgW = img.naturalWidth; imgH = img.naturalHeight;

  // Desired scale from DPR
  let scale = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

  // Cap by total pixel budget and per-side limit
  const byPixels = Math.sqrt(MAX_BACKING_PIXELS / (imgW * imgH));
  const bySide   = Math.min(MAX_BACKING_SIDE / imgW, MAX_BACKING_SIDE / imgH);
  scale = Math.min(scale, byPixels, bySide);
  scale = Math.max(1, scale); // never below 1x

  const backW = Math.max(1, Math.floor(imgW * scale));
  const backH = Math.max(1, Math.floor(imgH * scale));

  canvas.width  = backW;
  canvas.height = backH;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.imageSmoothingEnabled = true;
  ctx.clearRect(0, 0, backW, backH);
  ctx.setTransform(scale, 0, 0, scale, 0, 0);
  ctx.drawImage(img, 0, 0, imgW, imgH);

  sizeViewerToImage();
}

// ===== Upload (with HEIC/HEIF detection and error handling) =====
fileInput.addEventListener('change', e => {
  const file = e.target.files?.[0];
  if (!file) return;

  if (/image\/(heic|heif)/i.test(file.type)) {
    hint.textContent = 'This photo is HEIC/HEIF and may not display in all browsers. ' +
      'If it fails, export as JPEG/PNG (Photos → Share → Save as Image) or set Camera → Formats → Most Compatible.';
  }

  const url = URL.createObjectURL(file);
  const img = new Image();

  img.onload = () => {
    drawImageHiDPI(img);
    hasImage = true; isScrambled = null; setButtons();
    hint.textContent = `Loaded: ${file.name} (${imgW}×${imgH}). Choose Encode (original) or Decode (scrambled).`;
    URL.revokeObjectURL(url);
    fileInput.value = "";
    adjustStagePadding();
  };

  img.onerror = () => {
    hint.textContent = 'Could not display this image. If it is HEIC/HEIF, export it as JPEG/PNG and try again.';
    URL.revokeObjectURL(url);
    fileInput.value = "";
  };

  img.src = url;
});

// ===== Encode / Decode =====
encodeBtn.addEventListener('click', () => {
  if (!hasImage) return;
  applyScramble(SEED_8_DIGITS);
  isScrambled = true; setButtons();
  hint.textContent = 'Scrambled. Share to send or Save Image.';
});
decodeBtn.addEventListener('click', () => {
  if (!hasImage) return;
  applyScramble(SEED_8_DIGITS);
  isScrambled = false; setButtons();
  hint.textContent = 'Decoded (restored). Share if you want to save it.';
});

// ===== Share (native if possible; otherwise open PNG in new tab) =====
shareBtn.addEventListener('click', async () => {
  if (!hasImage) return;
  try {
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png', 1.0));
    const canFileShare = (() => {
      try { return navigator.canShare && navigator.canShare({ files: [new File([blob],'image.png',{type:'image/png'})] }); }
      catch { return false; }
    })();

    if (canFileShare) {
      const file = new File([blob], 'image.png', { type: 'image/png' });
      await navigator.share({ files: [file], title: 'Image' });
      return;
    }

    // Fallback: open PNG in a new tab (then Save/Share from the tab)
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.target = '_blank';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 4000);
  } catch {
    try {
      const dataUrl = canvas.toDataURL('image/png', 1.0);
      window.open(dataUrl, '_blank');
    } catch {
      alert('Unable to share. Try long-pressing the opened image to Save/Share.');
    }
  }
});

// ===== Reset =====
resetBtn.addEventListener('click', () => {
  hasImage = false; isScrambled = null; imgW = imgH = 0;
  canvas.width = 2; canvas.height = 2;
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
  fileInput.value = ""; setButtons();
  hint.textContent = 'Cleared. Upload an image to begin.';
  adjustStagePadding();
});

// Initial layout
adjustStagePadding();
</script>
</body>
</html>
