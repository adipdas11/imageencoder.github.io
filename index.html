<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>StegoPad — Encode/Decode Image (One‑file)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#9aa4b2; --text:#e5ecf3; --acc:#7c3aed; --acc2:#22d3ee; --danger:#ef4444;
      --ring:0 0 0 2px rgba(124,58,237,.45), 0 10px 30px rgba(124,58,237,.15);
      --tb: 96px; /* toolbar height fallback */
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b0f14, #0b0f14 40%, #0d1320 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overflow-x:hidden}
    .app{min-height:100%;display:flex;flex-direction:column;}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(13,19,32,.9),rgba(13,19,32,.6));backdrop-filter: blur(10px);padding: max(12px, env(safe-area-inset-top)) 16px 12px;border-bottom:1px solid rgba(255,255,255,.06);}    
    h1{margin:0;font-size:clamp(16px, 2.6vw, 20px);letter-spacing:.3px;display:flex;align-items:center;gap:10px;font-weight:700}
    h1 .dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 0 20px rgba(34,211,238,.65)}

    .stage{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px 16px 0}
    .viewer{position:relative;background:radial-gradient(1200px 400px at 50% -200px, rgba(124,58,237,.15), transparent),
                          radial-gradient(600px 200px at 10% 0, rgba(34,211,238,.1), transparent),
                          var(--card);
            border:1px solid rgba(255,255,255,.06);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.3);
            min-height:320px; padding-bottom: calc(var(--tb) + 12px)}

    /* Responsive toolbar: auto-fit columns; wraps as needed; safe-area aware */
    .viewer .toolbar{position:absolute;left:8px;right:8px;bottom:8px;display:grid;gap:8px;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      max-width: calc(100% - env(safe-area-inset-left) - env(safe-area-inset-right) - 16px);
      padding-bottom: env(safe-area-inset-bottom)}

    .btn{appearance:none;border:none;border-radius:14px;padding:clamp(8px,1.8vw,12px) clamp(8px,1.6vw,12px);font-weight:700;color:var(--text);
         background:linear-gradient(180deg,#1a2435,#141c2b);border:1px solid rgba(255,255,255,.08);
         box-shadow:0 6px 18px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;gap:8px;
         transition:transform .06s ease, box-shadow .2s ease;touch-action:manipulation;font-size:clamp(12px,2.8vw,14px)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#2a3754,#1b2538);border-color:rgba(124,58,237,.45);box-shadow:var(--ring)}
    .btn.danger{background:linear-gradient(180deg,#3a1f25,#2a1417);border-color:rgba(239,68,68,.4);}
    .btn[disabled]{opacity:.5;filter:saturate(.5);pointer-events:none}
    .btn .ico{width:clamp(14px,2.6vw,18px);height:clamp(14px,2.6vw,18px);opacity:.9}

    canvas{display:block;width:100%;height:auto;max-height:62vh;object-fit:contain;background:
      repeating-conic-gradient(from 45deg, rgba(255,255,255,.05) 0 10deg, transparent 10deg 20deg) center/40px 40px}

    .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 2px 12px;flex-wrap:wrap}
    .meta .chip{font-size:12px;color:var(--muted);background:rgba(255,255,255,.05);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.06)}

    .footer{position:sticky;bottom:0;z-index:10;background:linear-gradient(0deg,rgba(13,19,32,.9),rgba(13,19,32,.6));
            backdrop-filter: blur(10px); padding:12px 16px max(12px, env(safe-area-inset-bottom)); border-top:1px solid rgba(255,255,255,.06)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .toast{position:fixed;left:50%;bottom:calc(16px + env(safe-area-inset-bottom));transform:translateX(-50%);
           background:#0b1220;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:12px;
           padding:10px 14px;font-size:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s ease;max-width:90%;text-align:center}
    .toast.show{opacity:1}

    @media (min-width: 560px){ canvas{max-height:70vh} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1><span class="dot"></span> StegoPad <span style="color:var(--muted);font-weight:600">· Encode / Decode</span></h1>
  </header>

  <main class="stage" role="main">
    <section class="viewer" aria-label="Image viewer">
      <canvas id="canvas" aria-label="Image canvas" width="640" height="360"></canvas>
      <div id="placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:600;letter-spacing:.2px;pointer-events:none">Tap <em style='color:var(--text);font-style:normal'>Upload</em> to start</div>
      <div class="toolbar" id="toolbar">
        <button id="btnUpload" class="btn primary" title="Upload image">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Upload
        </button>
        <button id="btnEncode" class="btn" title="Encode (scramble)"> 
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
          Encode
        </button>
        <button id="btnDecode" class="btn" title="Decode (unscramble)">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18"/><path d="M7 8l-4 4 4 4"/></svg>
          Decode
        </button>
        <button id="btnShare" class="btn" title="Share current image">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          Share
        </button>
        <button id="btnReset" class="btn danger" title="Reset">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
          Reset
        </button>
      </div>
      <input id="file" type="file" accept=".stego,image/*" class="sr-only" />
    </section>

    <div class="meta">
      <span id="status" class="chip">No image loaded</span>
      <span id="dim" class="chip">–</span>
    </div>
  </main>

  <footer class="footer">
    <div style="font-size:12px;color:var(--muted);line-height:1.4">
      Tip for WhatsApp: send the <strong>.stego</strong> file as a <strong>Document</strong> (not as an image) to preserve exact pixels for decoding.
    </div>
  </footer>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // --- HARD-CODED CRYPTO-LITE SETTINGS (do NOT change to stay compatible) ---
  const SEED = 0xC0FFEE ^ 0x5EEDBEEF;   // deterministic PRNG seed (fixed)
  const KEY  = 0xA1B2C3D4;              // extra xor key (fixed)
  // Reversible XOR stream cipher based on xorshift32 (fast & deterministic)
  function* prng(seed){
    let x = seed >>> 0;
    while (true){
      x ^= x << 13; x >>>= 0;
      x ^= x >>> 17; x >>>= 0;
      x ^= x << 5;  x >>>= 0;
      yield x >>> 0;
    }
  }
  function scrambleImageData(imgData){
    const p = prng(SEED ^ imgData.width ^ (imgData.height<<16) ^ KEY);
    const d = imgData.data;
    for (let i=0;i<d.length;i+=4){
      const r = p.next().value;
      d[i]   = (d[i]   ^ ((r      ) & 0xFF))       >>> 0; // R
      d[i+1] = (d[i+1] ^ ((r >>> 8) & 0xFF))       >>> 0; // G
      d[i+2] = (d[i+2] ^ ((r >>>16) & 0xFF))       >>> 0; // B
    }
    return imgData;
  }

  // --- DOM helpers ---
  const $ = sel => document.querySelector(sel);
  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently:true });
  const input = $('#file');
  const status = $('#status');
  const dim = $('#dim');
  const toastEl = $('#toast');
  const toolbar = $('#toolbar');
  const viewer = document.querySelector('.viewer');

  const btnUpload = $('#btnUpload');
  const btnEncode = $('#btnEncode');
  const btnDecode = $('#btnDecode');
  const btnShare  = $('#btnShare');
  const btnReset  = $('#btnReset');

  let hasImage = false;
  let encoded = false; // whether the pixels currently on canvas are encoded
  let originalBitmap = null; // ImageBitmap or Canvas of the original (for Reset)
  let naturalW = 0, naturalH = 0; // original pixel dimensions

  function showToast(text){
    toastEl.textContent = text;
    toastEl.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.classList.remove('show'), 1600);
  }

  function updateButtons(){
    btnEncode.disabled = !hasImage;
    btnDecode.disabled = !hasImage;
    btnShare.disabled  = !hasImage;
    btnReset.disabled  = !hasImage;
    const ph = document.getElementById('placeholder');
    if (ph) ph.style.display = hasImage ? 'none' : 'flex';
  }

  function setStatus(text){ status.textContent = text; }

  function fitToCanvas(w, h){
    // Account for device pixel ratio for crisper rendering
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const maxWcss = Math.min(viewer.clientWidth - 2, 4096);
    const maxHcss = Math.min(Math.max(window.innerHeight * 0.62, 280), 4096);
    const scale = Math.min(maxWcss / w, maxHcss / h, 1);
    const cw = Math.max(1, Math.round(w * scale));
    const ch = Math.max(1, Math.round(h * scale));
    canvas.style.width = cw + 'px';
    canvas.style.height = ch + 'px';
    canvas.width = Math.round(cw * dpr);
    canvas.height = Math.round(ch * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
  }

  async function drawBitmap(bmp){
    naturalW = (bmp.width||bmp.naturalWidth); naturalH = (bmp.height||bmp.naturalHeight);
    fitToCanvas(naturalW, naturalH);
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.drawImage(bmp, 0,0, canvas.width / (window.devicePixelRatio||1), canvas.height / (window.devicePixelRatio||1));
    dim.textContent = `${naturalW}×${naturalH}px`;
    hasImage = true; encoded = false; updateButtons();
  }

  async function loadFile(file){
    if (!file) return;
    const isStego = file.name.toLowerCase().endsWith('.stego');
    try{
      let srcBlob = file;
      if (isStego){
        const buf = await file.arrayBuffer();
        srcBlob = new Blob([buf], { type:'image/png' });
      }
      const url = URL.createObjectURL(srcBlob);
      const bmp = await createImageBitmap ? await createImageBitmap(srcBlob) : await new Promise((resolve, reject)=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=url; });
      URL.revokeObjectURL(url);
      originalBitmap = bmp;
      await drawBitmap(bmp);
      setStatus(`Loaded: ${file.name}`);
    }catch(err){ console.error(err); showToast('Failed to load image'); }
  }

  function applyScramble(){
    if (!hasImage) return;
    const img = ctx.getImageData(0,0,canvas.width, canvas.height);
    scrambleImageData(img);
    ctx.putImageData(img, 0, 0);
  }

  function encodeNow(){
    if (!hasImage){ showToast('Upload an image first'); return; }
    if (encoded){ showToast('Already encoded'); return; }
    applyScramble();
    encoded = true; setStatus('Image encoded (scrambled)');
  }

  function decodeNow(){
    if (!hasImage){ showToast('Upload an image first'); return; }
    if (!encoded){ showToast('Image is already decoded'); return; }
    applyScramble();
    encoded = false; setStatus('Image decoded (original restored)');
  }

  btnShare.onclick = async () => {
    if(!hasImage){ showToast('Nothing to share'); return; }
    canvas.toBlob(async blob => {
      const pngFile = new File([blob], encoded? 'image-encoded.png' : 'image.png', { type: 'image/png' });
      const stegoFile = new File([blob], encoded? 'image-encoded.stego' : 'image.stego', { type: 'application/octet-stream' });
      try{
        if (navigator.share && navigator.canShare && navigator.canShare({ files:[pngFile,stegoFile] })){
          await navigator.share({ files:[pngFile,stegoFile], title:'StegoPad', text:'Send the .stego as a Document to preserve exact pixels (e.g., WhatsApp).'});
        } else if (navigator.share && navigator.canShare && navigator.canShare({ files:[pngFile] })){
          await navigator.share({ files:[pngFile], title:'StegoPad' });
          showToast('Tip: In WhatsApp, send the .stego as a Document to avoid compression.');
        } else {
          const url1 = URL.createObjectURL(blob);
          const a1 = document.createElement('a'); a1.href=url1; a1.download=pngFile.name; a1.click();
          const url2 = URL.createObjectURL(new Blob([blob],{type:'application/octet-stream'}));
          const a2 = document.createElement('a'); a2.href=url2; a2.download=stegoFile.name; a2.click();
          setTimeout(()=>{URL.revokeObjectURL(url1); URL.revokeObjectURL(url2);}, 1000);
          showToast('Downloaded PNG and .stego. Share .stego as Document in WhatsApp.');
        }
      }catch(e){ console.error(e); showToast('Share failed'); }
    }, 'image/png', 1);
  };

  async function resetAll(){
    if (!hasImage){ setStatus('No image loaded'); return; }
    try{
      if (originalBitmap){ await drawBitmap(originalBitmap); }
      ctx.clearRect(0,0,canvas.width, canvas.height);
      hasImage = false; encoded = false; originalBitmap = null; dim.textContent = '–';
      updateButtons(); setStatus('Reset complete');
    }catch(err){ console.error(err); }
  }

  // --- Wire up UI ---
  btnUpload.addEventListener('click', ()=> input.click());
  input.addEventListener('change', e => loadFile(e.target.files[0]));
  btnEncode.addEventListener('click', encodeNow);
  btnDecode.addEventListener('click', decodeNow);
  btnReset.addEventListener('click', resetAll);

  // Keep the viewer padding in sync with toolbar height (so buttons never overlap canvas)
  const ro = new ResizeObserver(() => {
    const tb = toolbar.getBoundingClientRect().height;
    viewer.style.setProperty('--tb', Math.ceil(tb) + 'px');
  });
  ro.observe(toolbar);
  window.addEventListener('orientationchange', () => setTimeout(()=>{
    if (hasImage) fitToCanvas(naturalW, naturalH);
  }, 250), { passive:true });
  window.addEventListener('resize', () => {
    if (hasImage) fitToCanvas(naturalW, naturalH);
  }, { passive:true });

  // Drag & drop (desktop convenience)
  ;['dragenter','dragover'].forEach(ev=>document.addEventListener(ev, e=>{e.preventDefault();e.dataTransfer&& (e.dataTransfer.dropEffect='copy');}))
  document.addEventListener('drop', e=>{e.preventDefault(); if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);});

  // Initial state
  updateButtons();
})();
</script>
</body>
</html>
